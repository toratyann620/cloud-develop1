# 第 2 章 Lambda 事始め

Lambda の本質は、あらかじめ AWS に関数を登録しておくと、それを実行できる仕組みにほかなりません。とはいえ実行可能な関数は、引数や戻り値の書式、エラーの返し方などが決まっており、好きな関数を登録できるわけではありません。

本章では、実際に構造の簡単なサンプルプログラムを作りながら、どのような関数を、どのようにして登録すれば実行できるのか、その流れを説明します。

本章のポイント

- Lambda 関数の構造と設計<br>
  Lambda で実行したい処理は、規定の書式に従った関数として記述します。入力値は関数の引数として渡され、関数の戻り値が、呼び出し元へと返されます。
- Lambda の利用に必要なアクセス権<br>
  Lambda 関数を作ったり実行したりする操作には、適切なアクセス権が必要です。開発者の IAM ユーザーと、Lambda 関数を実行するときに使う IAM ロールを、あらかじめ作成しておきます。
- Lambda 関数の実行<br>
  AWS マネジメントコンソールから、テストイベントを作成すると、登録した Lambda 関数を実行できます。実行時のログは、CloudWatch Logs に書き込まれます。標準出力に出力したデータも、CloudWatch Logs に書き込まれます。

## 2-1 Lambda を使う上で理解したいこと

第 1 章でも説明したように、Lambda は関数単位の実行環境であり、「あらかじめ関数を登録しておくと、それを実行できる」という仕組みです(図 2-1)。

![図2-1 Lambdaの実態](2-1.png){data-zoomable}

<div style="text-align: center;">

図 2-1 Lambda の実態

</div>

Lambda を使い始めるに当たって、まず知らなければならないことは、次の 4 点です。

1. 関数の書式<br>
   Lambda として登録できる関数は、規定の書式に則ったものでなければなりません。命名規則や引数の数など、いくつかの決まりごとがあります。
2. 関数の登録方法<br>
   1 の関数を、どのように登録するかです。Lambda 関数は、さまざまな方法で登録できます。最も簡単なのは、AWS マネジメントコンソールからコードを書いて登録する方法です。 ほかにも、好みのエディタを使って作ったものをアップロードする方法や、CI/CD 環境でデプロイする方法もあります。
3. 関数を呼び出す方法<br>
   (2)で登録した関数を、どのようにして呼び出すかです。開発者が動作テストの目的で、AWS マネジメントコンソールから手動で呼び出すほか、別途開発したプログラムから呼び出すこともできます。また、「S3 バケットにファイルが書き込まれたとき」「SES(Amazon Simple Email Service: メールの送受信サービス)でメールが届いたとき」など、何らかのイベントと結び付けることもできます。
4. アクセス権<br>
   2 のように関数を登録するには、その登録作業をするユーザー(開発者)に、適切な権限が必要です。そして登録した Lambda 関数自体にも適切なアクセス権を設定しないと、Lambda 実行環境上で実行できません。こうしたアクセス権は、IAM ユーザーや IAM ロールとして構成します。

## 2-2 本章で作るシンプルな Lambda 関数

本章では、シンプルな Lambda 関数を作りながら、いま述べた 4 つの事柄を中心に、Lambda の基本を説明していきます。
あまり複雑なものを扱うとわかりにくいので、ここでは、本当にシンプルな「割り算をするだけの関数」を考えます。「x」と「y」の引数を渡すと、それらの値を、まず、CloudWatch Logs\*に ログとして出力し、戻り値として「x-y」の計算結果を返すものです(図 2-2)。

![図2-2 本章で作成する Lambda関数](2-2.png){data-zoomable}

---

\*1 ログデータを記録したりモニタリングしたりする AWS のサービス。以下の URL を参照。
[https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/WhatIsCloudWatch.html](https://docs.aws.amazon.com/ja_jp/AmazonCloudWatch/latest/monitoring/WhatIsCloudWatch.html)

---

引数は、次のように JSON\*2 形式で渡すものとします。Lambda 関数が受け取る引数は、この例に限らず、JSON 形式を使うのが慣例です。

```json
{ "x": 10, "y": 2 }
```

戻り値については、この限りではありませんが、やはり JSON 形式の値を返すことが多いので、戻り値も同じく、次のように JSON 形式で返すものとします。

```json
{ "result": 5 }
```

::: tip JSON 形式について
厳密に言うと、JSON 形式であることは必須条件ではありませんが、さまざまな Lambda 開発ツールやライブラリが JSON を前提としているため、JSON 形式以外にすると、開発が少し複雑になる可能性があります。
:::

## 2-3 Lambda 関数の構造と設計

Lambda 関数には、引数や戻り値の書式、エラーの返し方など、さまざまな規定があります。こうした規定は、プログラミング言語によって異なります。本書では、Python3 について説明します。

### 2-3-1 Lambda 関数の書式

Python3 で記述する Lambda 関数は、次のように、2 つの引数を持ちます。

```python
def 関数名 (event, context):
    ... 関数の処理 ...
    return 戻り値
```

Lambda 関数はハンドラとも呼ばれます。そこで慣例的に、関数名として、「機能名\_handler」という名称を付けることがあります。

たとえば次のプログラムは、myfunc_handler という関数名を付けた例です。

```python
def myfunc_handler (event, context):
    ... 関数の処理 ...
    return 戻り値
```

---

\*2 JSON (Java Script Object Notation)。オブジェクトをテキストで表現する方式のひとつ。

オブジェクトは「{}」 で囲み、文字列は「"」で囲む。名前/値は「:」で区切り、名前/値のペアは「,」で区切る。

詳細な文法 については、以下の URL を参照。 [https://datatracker.ietf.org/doc/html/rfc8259](https://datatracker.ietf.org/doc/html/rfc8259)

---

関数の引数として指定した event と context の 2 つの引数には、それぞれ「イベントの情報」と 「コンテキストの情報」が渡されます(ここでは便宜的に引数を受け取る変数を、それぞれ event、context としましたが、引数名は任意の名称でかまいません)。

■ イベントの情報(event 引数) <br>
イベントの情報とは、関数に渡される入力データです。これから作っていくサンプルであれば、 「{"x" : 10, "y" : 2}」のような JSON データです。

より汎用的に言えば、イベントから渡される任意の値です。第 1 章で説明したように、Lambda 関数は、S3(Simple Storage Service) や SES (Simple Email Service)などで発生するイベントをトリガーとして呼び出されます。

このとき、event 引数には、こうしたイベントに関連する情報が格納されて呼び出されます。
たとえば、「イベントが発生した時刻」「ファイルが置かれた場所のパス」「メールを受信した際の受信メールアドレス」などが含まれた情報です。

書式や内容は、イベントによって異なります。

イベントのデータは、ほとんどの場合、JSON 形式の文字列です。この文字列は、Lambda 関数の引数として渡されるときは、パース済みです。たとえばイベントのデータが、次の JSON 文字 列であるとします。

```json
{ "x": 10, "y": 2 }
```

このイベントデータを、以下の書式の Lambda 関数で受け取る場合を考えます。

```python
def myfunc_handler(event, context):
```

このとき引数 event は、JSON 文字列ではなく、パースされて Python のオブジェクトに変換されています。そのため、イベントデータとして渡された x と y の値は、それぞれ、

```
event["x"] は「10」
event["y"] は「2」
```

として取得できます。

■ コンテキストの情報(context 引数) <br>
Lambda 関数は、AWS が提供する Lambda 実行環境のなかで実行されます。コンテキストの情報は、この実行環境の情報です。

たとえば、「割り当てられているメモリ容量」「Lambda 関数が 配置されているパス名」「一時ディレクトリのパス名」などが、この引数を通じて得られます。詳細は、「3-1-3 Lambda ランタイムの環境」で説明します。

■ 戻り値 <br>
Lambda 関数が return 文で返した戻り値は、Lambda 関数の出力として扱われます。これから 作っていくサンプルであれば、`{"result" : 5}`といった計算結果です。

より汎用的に言えば、イベントに返したい任意の値です。戻り値が、どのような意味を持ち、どのようなデータ構造であるべきなのかは、イベントによって異なります。イベントによっては、戻り値が無視されることもあります。

### 2-3-2 Lambda 関数のサンプルを作る

ここまでの説明を踏まえて、「2-2 本章で作るシンプルな Lambda 関数」で説明した動作をする Lambda 関数を実際に作ったものが、リスト 2-1 です。ここでは Lambda 関数名を`myfunc01_handler`としました。

```
○ プログラムの仕様 ○
イベント引数として JSON 形式の`{"x": x の値, "y": y の値}`を与えると、
そのxとyを print で出力して、`x = y`の結果をJSON 形式の`{"result" :答え}`の形式で返す。
```

リスト 2-1 割り算の結果を返す Lambda 関数

```python
import json # import文でjsonモジュールにアクセスする
def myfunc01_handler(event, context): # 関数の宣言
    x = int(event["x"])
    y = int(event["y"])
    print("x = " + str(x)) # print関数で文字列を出力
    print("y = " + str(y))
    retval = {"result" : x / y}
    return json.dumps(retval) # JSON形式で結果を返す
```

リスト 2-1 では、まず、渡された event 引数から x と y の値を得ます。この関数は、呼び出される際に、`{"x" : xの値, "y" : yの値}`形式の JSON 文字列が渡されることを想定しています。
この JSON 文字列はパースされて、この Lambda 関数に渡されます。すなわち次のように、 event["x"]、event["y"] として、渡された値を取得できます。

ここでは、のちに`x / y`と いう除算をするので、int 関数を使って文字列から整数に変換しています。

```python
x = int(event ["x"])
y = int(event ["y"])
```

そして、その値 print 関数を使って、標準出力へと書き出しています。あとで実際に動作を確認しますが、この出力は、CloudWatch Logs に、そのまま出力されます。

```python
print("x = " + str(x))
print("y = " + str(y))
```

そして最後に、戻り値を設定します。ここでは json.dumps メソッドを使って、除算の結果を JSON 文字列に変換したものを返しています。

```python
retval = {"result" : x / y}
return json.dumps(retval)
```

## 2-4 Lambda の利用に必要なアクセス権

早速 AWS マネジメントコンソールを使って、リスト 2-1 に示した Lambda 関数を作っていきたいところですが、その前に、必要な IAM(Identity and Access Management)ユーザーと IAM ロールについて、説明します。

### 2-4-1 IAM ユーザーと IAM ロール

IAM ユーザーは操作するユーザー(たとえば開発者など)ならびにそのユーザーに与える権限のこと、IAM ロールはプログラムに対して与える権限のことです。

- IAM ユーザー <br>
  操作しているユーザーに紐付くアカウントです。

以降では、AWS マネジメントコンソールを使って Lambda 関数を作っていきますが、ルートアカウント\*3(管理者アカウント)で操作することは推奨されていません。

開発者用の IAM ユーザーを別途作成しておき、Lambda 関数を作成・登録(デプロイ)や実行(テスト)する際には、そのユーザーで操作することが望まれます。

- IAM ロール <br>
  IAM ロールは、Lambda 関数や EC2 インスタンスなど、実行するプログラムやサービス ——つまり人間以外—— に紐付くアカウントで、そのプログラムやサービスがどのような権限を持つのかを規定します。

具体的に言うと、「S3 にアクセスできる」「メールを送信できる」などの権限を設定できます。

Lambda 関数を登録する際には、何かしらの IAM ロールを設定します。実行される際には、 その IAM ロールのもとで実行されます。

---

\*3 AWS アカウントの作成時に入力したメールアドレスとパスワードでログインする管理者アカウントのこと。

Lambda に限らず、そもそも AWS ではルートアカウントは封印し、管理者として操作する場合も、別途、管理者用の IAM ユーザーを作って運用することが推奨されている。

---

### 2-4-2 Lambda の利用に必要なアクセス権

Lambda では、次の 3 つのアクセス権が関与します(図 2-3)。

![図2-3 Lambdaに関与するアクセス権](2-3.png){data-zoomable}

- Lambda 関数の登録権限(開発者用の IAM ユーザー) <br>
  開発者は、AWS マネジメントコンソールなどを用いて、AWS 上に Lambda 関数を登録しますが、その際、lambda:CreateFunction という権限が必要です。

  開発者の IAM アカウントには、この権限が必須です。

- Lambda 関数の実行権限(開発者用の IAM ユーザーやイベントの発生源など呼び出し元に対する IAM ロール)<br>
  登録した Lambda 関数を実行するには、lambda: InvokeFunction という権限が必要です。本章では、開発者が AWS マネジメントコンソールから操作して、登録した Lambda 関数を手作業で実行してテストします。そのため開発者の IAM アカウントに、lambda: InvokeFunction の権限がないと、実行に失敗します。

  手動で実行しないのであれば、開発者に対する lambda:InvokeFunction 権限は必須ではありません。しかしテストやデバッグなどの際に、手動で実行する場面は少なくありません。

  ですから手動で実行しない場合でも、開発者には lambda:InvokeFunction の権限をあらかじめ与えておくべきです。

- Lambda 関数の実行ロール (Lambda 関数自体に設定する IAM ロール)<br>
  Lambda 関数は、登録する際に決めた IAM ロールのもとで実行されます(後述)。この IAM ロールによって、Lambda 関数の処理において、どのような操作ができるのかが決まります。

Lambda 関数は、ログを CloudWatch Logs へ書き込むので、この IAM ロールには、最低限、Cloud Watch Logs へ書き込む権限が必要です。具体的には、logs:PutLogEvents、logs:CreateLog Stream、logs:CreateLogGroup の 3 つの権限です。

ほかにも Lambda 関数から S3 や DynamoDB\*4 など、Lambda 関数の処理内で、AWS のリソースを操作したいときには、この IAM ロールに対して、それらのリソースへのアクセス権が必要です。

---

\*4 キーバリュー型のデータベース。第 6 章にて説明。

---

### 2-4-3 Lambda 関数の作成・登録や実行に関わる管理ポリシー

こうしたアクセス権を、ひとつずつ設定するのは煩雑なため、アクセス権の設定には、既存の管理ポリシーを適用します。

既存の管理ポリシーを適用すれば、適切なアクセス権を持った IAM ユーザーや IAM ロールを簡単に構成できます。

開発者が手動で実行する Lambda 関数を作る場合は、開発者となる IAM ユーザーと、Lambda 関数に結び付ける IAM ロールを、それぞれ次のように構成します。

■ 開発者となる IAM ユーザーに割り当てる管理ポリシー <br>
開発者となる IAM ユーザーには、表 2-1 に示すいずれかのポリシーを適用します。

いくつかの ポリシーがありますが、Lambda に関する全アクセス権が構成されている AWSLambda_FullAccess ポリシーを適用するのが簡単です。
このポリシーを適用すると、Lambda 関数を作ったり実行したりできるようになります。

また、AWSLambdaFullAccess ポリシーには、Lambda 関数と一緒に使うことが多い S3 や DynamoDB などへの書き込み権限も付与されています。

表 2-1 開発者となる IAM ユーザーに割り当てる管理ポリシー
| ポリシー| 意味 |
|----|----|
|AWSLambda_ReadOnly Access|Lambda および DynamoDB、S3 など、Lambda 関連の各種リ ソースへの読み取り専用アクセス権 。このポリシーには lambda:InvokeFunction の権限がないため、Lambda 関数を実行することはできない|
|AWSLambdaRole|Lambda 関数の実行権限(lambda:InvokeFunction)のみを設定した もの。任意の Lambda 関数を実行できるが、Lambda 関数を作成し たり、一覧を取得したりすることはできない|
|AWSLambda_FullAccess|Lambda および DynamoDB、S3 など、Lambda 関連の各種リソース へのフルアクセス権。Lambda 関数を実行するほか、Lambda 関数 を作成したり、変更したり、削除したりできる|

■ Lambda 関数に結び付ける IAM ロールに割り当てる管理ポリシー <br>
Lambda 関数に結び付ける IAM ロールには、表 2-2 に示す、いずれかのポリシーを適用します。

ほとんどの場合、ポリシーとして、AWSLambdaBasicExecutionRole を適用すれば十分です。
このポリシーは、CloudWatch Logs への書き込みアクセス権 (10gs:PutLogEvent、logs:CreateLogStream、 logs:CreateLogGroup)を与えます。

AWSLambdaKinesisExecutionRole と AWSLambdaDynamoDBExecutionRole は、それぞれ Kinesis や DynamoDB における処理として、データの変化(ストリーミングデータ)を Lambda 側で拾うときに使うものです。
そして AWSLambdaVPCAccessExecutionRole は、Lambda 関数から、仮想ネットワークである VPC にアクセスするときに必要となるものです(「3-8 Lambda のネットワーク」を参照)。

表 2-2 Lambda 関数を実行する IAM ロールに割り当てるポリシー
|ポリシー|意味|
|----|----|
|AWSLambdaBasicExecutionRole|CloudWatch Logs への書き込みアクセス権として 3 つの権限(「logs:PutLogEvents」「logs:CreateLogStream」 「logs:CreateLogGroup」)を付与する|
|AWSLambdaKinesisExecutionRole|AWSLambdaBasicExecutionRole に加えて、Kinesis Streams アクションへのアクセス権限を付与する|
|AWSLambdaDynamoDBExecutionRole|AWSLambdaBasicExecutionRole に加えて、DynamoDB アクションへのアクセス権限を付与する|
|AWSLambdaVPCAccessExecutionRole|AWSLambdaBasicExecutionRole に加えて、ENI (Elastic Net work Interface)を管理する EC2 アクションへのアクセス権限を付与する。 Lambda 関数から、VPC にアクセスしたいときに用いる|

### 2-4-4 IAM ユーザーと IAM ロールを作成する

ここまで説明してきたように、Lambda を利用するには、最低限、開発者の IAM ユーザーと Lambda の実行ロールを、Lambda 関数の作成・登録前に用意しておく必要があります。

以降を読み進める前に、次のように、IAM ユーザーと IAM ロールを作成しておいてください。

- 開発者の IAM ユーザー <br>
  本書では、以降、AWS マネジメントコンソールから Lambda 関数の作成・登録、そして、 動作テストをしていきます。この操作には、最低限、AWSLambda_FullAccess ポリシーを適 用した IAM ユーザーが必要です。ほかにも第 4 章では、Cloud9 や AWS Serverless Application Model(SAM)と呼ばれるフレームワークを使って開発しますし、第 5 章以降では、S3 や DynamoDB などの AWS リソースを操作するため、さらに追加の権限も必要です。

  こうした権限は、ひとつひとつ最低限の権限だけを設定していくのがセキュリティの基本ですが、開発の段階で権限の不足があると、プログラムの不具合なのか、それとも権限が足りないのかの区別が付きにくくなります。そこで本書では、皆さんが利用している AWS 環 境が本番環境ではなく、あくまでも開発環境であると想定し、開発者には、すべての管理者権限を持つ AdministratorAccess ポリシーを適用することにします。その方法については、 Appendix A を参照してください。

- Lambda の実行ロール<br>
  AWSLambdaBasicExecutionRole の権限を付与した IAM ロールをあらかじめ作成しておき ます。ロール名は任意ですが、本書では、「example-lambda-role」という名前にします。本書では、Lambda 関数から S3 や DynamoDB などの AWS リソースを操作するプログラムも作るので、さらに追加の権限も必要です。
  [Appendix B](/2/appendix_b) を参考にして、こうした権限を持つ IAM ロールを作成しておいてください。

::: tip Lambda 関数の作成時に Lambda の実行ロールを作成する
Lambda の実行ロール(IAM ロール)は、事前に作成せずに、Lambda 関数を作成・登録するときに、一緒に作ることもできます。

ただしその場合は、Lambda 関数の作成・登録操作をしている IAM ユーザー(開発者)に対して、iam:CreateRole の権限が必要です。
:::

## 2-5 Lambda 関数の作成・登録

それでは実際に、AWS マネジメントコンソールで操作し、Lambda 関数を作成していきます。

「2-4 Lambda の利用に必要なアクセス権」で説明したように、本書では、開発者には AdministratorAccess のポリシーを適用した IAM アカウントを使います。以下の操作は、このポリシーを適用した IAM アカウントでサインインして操作してください\*5。

### 2-5-1 Lambda コンソールを開く

Lambda 関数は、AWS マネジメントコンソールの Lambda コンソールから操作します。

マネジメントコンソールで「Lambda」を検索し(図 2-4)、Lambda コンソールを開いてください。

![図 2-4 Lambda コンソールを開く](2-4.png){data-zoomable}
図 2-4 Lambda コンソールを開く

---

\*5 厳密に言うと、この章の操作は、Lambda 関数のみの管理者権限である AWSLambda_FullAccess ポリシーだけで適用すれば、事足ります。

---

すると、関数の一覧画面が表示されます。[関数の作成]ボタンをクリックすると、Lambda 関数の作成を開始できます(図 2-5)。
※東京リージョンで作業をしていることを確認してください。
![図 2-5 Lambda 関数を作り始める](2-5.png){data-zoomable}
図 2-5 Lambda 関数を作り始める

### 2-5-2 Lambda 関数の作成

作成画面が表示されたら、Lambda 関数を作成していきます。

■ Lambda 関数の作成方法<br>

新規作成画面では、次の 4 種類の方法で、Lambda 関数を作成できます。

- 一から作成<br>
  シンプルなひな形のテンプレートから作り始めます。
- 設計図の使用<br>
  「S3 バケットにファイルが置かれたとき」「Web アプリケーションとして」など、さまざまなシナリオを前提とした設計図(blueprint、青写真)から選び、そのサンプルをもとに作成します。
- コンテナイメージ<br>
  コンテナイメージを登録します。本書ではコンテナ型の Lambda 関数については触れません(コラム「ZIP 形式の Lambda 関数とコンテナ形式の Lambda 関数」(p.27) を参照)。
- Serverless Application Repository の参照<br>
  Serverless Application Repository と呼ばれるサーバーレスアプリケーション登録用のリポジトリに登録されているアプリケーション(Lambda 関数並びにデータなど、構成するすべてのリソース一式)を登録します。詳細については、第 4 章で説明します。

  自分の目的に近い設計図を選ぶと、その動作に必要な各種設定と、標準的なサンプルコードが 自動入力されるので、プログラミング作業が楽になります。とはいえ本章では、冒頭のリスト 2-1 (p.35)に示したように、作成する Lambda 関数が決まっているので、こうした自動生成の機能は使わず、「一から作成]を選択することにします(図 2-6)。

  ![図 2-6 [一から作成]を選ぶ](2-6.png){data-zoomable}
  図 2-6 [一から作成]を選ぶ

  ■ 関数名とランタイム、実行ロールの選択<br>
  その下にある「基本的な情報]の部分では、まず、「関数名」と「ランタイム」、「アーキテク チャ」そして「アクセス権限」を設定します(図 2-7)。

  ![図 2-7 基本的な情報](2-7.png){data-zoomable}
  図 2-7 基本的な情報

- 関数名<br>
  「関数名」は、関数に付ける名前です。他の Lambda 関数と重複しない任意の名前を付けられます。ここでは、`helloFunction_[自分の出席番号 2 桁]`という名前にします。
- ランタイム<br>
  「ランタイム」には、実行環境を選択します。本書では、Python3 でプログラミングします。本書の執筆時点において最新版である、[Python 3.9]を選択します。
- アーキテクチャ<br>
  Lambda 実行環境のアーキテクチャです。[x86_64] (x86 ベース。既定)か[arm64] (Arm ベース)かの、いずれかを選択できます。

2021 年 9 月、Lambda 実行環境がバージョンアップし、従来の x86 ベースに加えて Arm ベースのアーキテクチャがサポートされたため、この選択肢があります。Arm ベースの実行 環境は、x86 ベースの実行環境に比べて、安価で高性能です。このサンプルでは、どちらを選んでも大差ありません。ここでは、とくに何も考えず、既定の[x86_64] を選択することにします。

::: tip [設計図の使用]から作成するときは、アーキテクチャの選択がない
第 3 章では、[設計図の使用]から Lambda 関数を作成する方法を説明しますが、この場合は、アーキテクチャの選択項目がありません。その理由は、設計図側でアーキテクチャが決め打ちされているためです。
:::

- デフォルトの実行ロールの変更
  この Lambda 関数を実行する IAM ロールを設定します。ここでは、[Appendix B](/2/appendix_b) に示す手順で AWSLambdaBasicExecutionRole ポリシーが適用された「example-lambda-role」というロールを作成済みであることを前提に、[既存のロールを使用する]を選択し、[既存のロール]から、それを選択します。

[既存のロールを使用する]で選択できるのは、Lambda の実行に必要な権限を持つロールだけです。もし選択肢のなかに何も IAM ロールが表示されていないときは、[Appendix B](/2/appendix_b) の操作手順に従いロールを作成してください。

※この授業では、ロールを皆さんが作るのではなく先生が作るところを見せて、皆さんがそのロールを自分の関数にアタッチするという形をとります。

::: tip その場で IAM ロールを作成する
図 2-7 において、[基本的な Lambda アクセス権限で新しいロールを作成]や[AWS ポリ シーテンプレートから新しいロールを作成]を選択すると、この場で IAM ロールを作成できます。ただし、iam:CreateRole 権限を持たないユーザーで操作すると、失敗します。
:::

■ 詳細設定<br>
詳細設定では、コードに署名を付ける設定と VPC の設定ができます(図 2-8)。

- コード署名<br>
  コード署名を有効にすると、コードが第三者によって書き換えられていないかを検出でき ますが、本書での説明は割愛します。空欄のままにしておいてください。詳細について知りたい人は、「AWS Lambda でのコード署名の設定」を参照してください。
- VPC<br>
  この Lambda 関数が、VPC(仮想ネットワーク)と通信したいときは、接続したい VPC を 選択します。本書で作成する Lambda 関数は VPC に接続しないので、空欄にしておいてください。詳細は、「3-8 Lambda のネットワーク」で説明します。

上記の設定が終わったら、[関数の作成]ボタンをクリックします。すると、Lambda 関数が作成・登録されます。

![図 2-8 詳細設定](2-8.png){data-zoomable}
図 2-8 詳細設定

---

\*6 AWS Lambda でのコード署名の設定
[https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/configuration-codesigning.html](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/configuration-codesigning.html)

---

### 2-5-3 Lambda 関数の編集画面

Lambda 関数が作成・登録され、Lambda 関数の編集画面が表示されます。「関数の概要」「コードソース」「コードのプロパティ」「ランタイム設定」「レイヤー」の 5 つの領域に分かれています (図 2-9(1))。
![図 2-9 (1) Lambda 関数の編集画面](2-9-1.png){data-zoomable}
図 2-9 (1) Lambda 関数の編集画面

- 関数の概要<br>
  この Lambda 関数が呼び出されるイベントのトリガー(発生源)や、この Lambda 関数がアクセスする AWS リソースなどを定義します。この設定については、第 3 章以降で、実例を示すときに説明します。
- コードソース<br>
  Lambda 関数のコードを編集するエディタ部分です。[コード] [テスト] [モニタリン グ] [設定][エイリアス] [バージョン]のタブ切り替えとなっており、これらのタブをクリックすることで、コードソース以外の画面に切り替わります。

  ![コードソース](2-9-1-1.png){data-zoomable}

- コードのプロパティ<br>
  サイズや登録日など、コードの情報が表示されています。

  ![コードのプロパティ](2-9-1-2.png){data-zoomable}

- ランタイム設定<br>
  ランタイムの設定情報です。ランタイムの言語のほか、ハンドラと呼ばれる情報があります。
  ハンドラとは、この Lambda 関数が実行される際、呼び出される関数のことです。Python で記述する場合、次のように「ファイル名」と「関数名」をピリオドでつなげた書式で記述します。
  **ファイル名. 関数名**
  ここでは「lambda_function.lambda_handler」が設定されています。これは、lambda_function.py というファイル名の Python ソースに含まれる lambda_handler 関数が実行されるという意味で
  す。実際、この関数は、[コードソース]にひな形として作られています。
  ![ランタイム設定](2-9-1-3.png){data-zoomable}
- レイヤー
  Lambda には、ライブラリなどをあらかじめ Lambda 関数の動作に必要なベースとなるパッ ケージを登録しておける「レイヤー」という仕組みがあり、それに関する設定項目です。詳 細については、第 5 章で説明します。

::: tip 間違えて編集画面を閉じてしまったときは
間違えて編集画面を閉じてしまったときは、Lambda コンソールの[関数] をクリックし、表示された一覧から、編集したい Lambda 関数をクリックします(図 2-9 (2) )。
![図 2-9 (2) 一覧から Lambda 関数の編集画面を開く](2-9-2.png){data-zoomable}
図 2-9 (2) 一覧から Lambda 関数の編集画面を開く

:::

### 2-5-4 Lambda 関数のコードを書く

[一から作成する]を選択して Lambda 関数を作った場合、ごく簡単なひな形のコードが作られます。このひな形のコードを、すでにリスト 2-1 に示した「2 つの引数を渡して、その割り算 の結果を返す」というコードに変えていきましょう。

■ ファイル名と関数名の関係<br>
コードを変更する前に、まずは、ひな形として作られたコードの構造を理解し、自分で書いた コードに差し替えるには、どのような操作が必要なのかを整理しましょう。

[一から作成する]を選択して Lambda 関数を作った場合、lambda_function.py というファイ ルができ、そこに lambda_handler という関数が作られます(リスト 2-2)。ファイル名は、「コー ドソース」の左側のツリーで確認できます(図 2-10)。

```python 2-2 作成されたひな形(lambda_function.py)
import json
def lambda_handler(event, context):
    # TODO implement
    return {
        'statusCode': 200,
        'body': json.dumps ( 'Hello from Lambda!')
    }
```

![コードソース](2-9-1-1.png){data-zoomable}
図 2-10 コードソース

リスト 2-2 を見るとわかるように、これは「event」と「context」という 2 つの引数をとる関数で、Lambda の規約に則ったものです。

ひな形の関数は、Web アプリケーションを Lambda で実 装する処理例となっており、「statusCode」と「body」を返すという、そんなサンプルです。

ここで大事なのは、「ファイル名」と「関数名」です。lambda_function.py ファイルのなかの lambda_handler という関数です。
これは、ランタイム設定の「ハンドラ」の値として設定されています(図 2-11)。

ハンドラは、呼び出すべき「ファイル名. 関数名」を指定する設定値です。この設定が実際のソースファイルのファイル名、関数名と合致していないと、呼び出しが失敗するので注意してください。
![図 2-11 ハンドラの設定値は「ファイル名. 関数名」でなければならない](2-9-1-3.png){data-zoomable}
図 2-11 ハンドラの設定値は「ファイル名.関数名」でなければならない

■ コードを書き換える<br>
このようにハンドラによって呼び出される Python ファイルや関数名が結び付けられていることを確認したところで、本章の冒頭のリスト 2-1 で紹介した「割り算する処理」にプログラムを書き換えていきましょう。

リスト 2-1 を、次に再掲載します。

```python リスト 2-1 の再掲載
import json # import 文でjson モジュールにアクセスする
def myfunc01_handler(event, context): # 関数の宣言
    x = int(event["x"])
    y = int(event["y"])
    print("x = " + str(x)) # print 関数で文字列を出力
    print("y = " + str(y))
    retval = {"result" : x / y}
    return json.dumps(retval) # JSON 形式で結果を返す
```

このリストでは、「関数名」を「myfunc01_handler」にしていることに注意してください。

ですから、これを Lambda 関数として動かすには、関数名をひな形と同じ lambda_handler に変えるか、ハンドラの設定を変えるかしなければなりません。

ここでは以下の手順で、関数名は myfunc01_handler にして、ハンドラのほうを変更する方法で操作することにします。

○ 操作手順<br>
ひな形のコードを、リスト 2-1 に示した割り算する処理のサンプルに変更する

【1】コードソースを変更する<br>
・[コードソース]の部分のコードを、リスト 2-1 のように変更します(図 2-12 (1))。
![図 2-12(1) コードソースを変更する](2-12-1.png){data-zoomable}
図 2-12(1) コードソースを変更する

【2】変更を保存して反映する<br>
・編集すると図 2-12 (1)に示すように「Changes not deployed」と表示されます。これは編集 したけれども、まだ反映(デプロイ)されていないという意味です。

反映するため、[File] メ ニューから[Save] を選択して保存し(もしくは[Ctrl] +[S]キーを押す)、それから[Deploy] ボタンをクリックします。

![図 2-12(1) コードソースを変更する](2-12-2-1.png){data-zoomable}

・変更が反映されると、「Changes deployed」という**表示が消えます**(図 2-12 (2))。

[コードソース]の編集では、このように、[Deploy]しないと、その変更が反映されないので注意してください。

![図 2-12(2) 変更を反映する](2-12-2-2.png){data-zoomable}
図 2-12 (2) 変更を反映する

【3】ハンドラを変更する<br>
・リスト 2-1 の関数名は「myfunc01_handler」です。
そこでハンドラが、この関数を指すように変更します。

・[ランタイム設定]の[編集]をクリックします(図 2-13)。そして[ハンドラ]を`lambda_function. myfunc01_handler`に変更して[保存]をクリックします(図 2-14)。ピリオドの前の「lambda_function」 は、この Python プログラムのファイル名です。

**lambda_function.myfunc01_handler**

![図 2-13 ランタイム設定を編集する](2-9-1-3.png){data-zoomable}

図 2-13 ランタイム設定を編集する

![図 2-14 ハンドラを変更する](2-14.png){data-zoomable}

図 2-14 ハンドラを変更する

※変更すると以下のような画面が出ます
![図 2-14 ハンドラを変更する](2-14-1.png){data-zoomable}
[OK]をクリックしてください。

# 2-6 Lambda 関数のテスト

前節で作成した関数を手動で実行し、結果を確認してみましょう。Lambda コンソールにおい て、「テストイベント」というテスト用のイベントを定義することで、Lambda 関数を手動で実行できます。

## 2-6-1 テストイベントの定義

Lambda 関数のテストは、[テスト]タブから操作します。[テスト]タブをクリックして開くと、テストイベントを定義する画面が開きます(図 2-15)。

![テストタブを開いたところ。](2-15.png){data-zoomable}
図 2-15 [テスト] タブを開いたところ。

ここでは、いくつかの AWS のイベントから呼び出される際のテンプレートを選ぶこともできますが、ここで作成しているのは、「x」と「y」に値を設定すると、戻り値として「xy」の結果 を返す関数です。

こんなイレギュラーなテンプレートは AWS にはありませんから、新規に、この x と y を渡す引数を設定するテストイベントを作成します(図 2-16)

○ 操作手順<br>
テストイベントを登録する

【1】新しいイベントを選択する
・[新しいイベントを作成]を選択します。

![新しいイベントを選択する](2-16-1.png){data-zoomable}

【2】名前を入力する
・名前を入力します。どのような名前でもかまいませんが、ここでは「MyTestEvent」としておきます。

![名前を入力する](2-16-2.png){data-zoomable}

【3】Lambda 関数に渡す引数を設定する
・Lambda 関数に渡す引数を設定します。この値が、Lambda 関数のイベント引数として渡されます。ここでは、次の JSON 形式データを設定します。「x は 10、y は 2」としました。

```json
{
  "x": 10,
  "y": 2
}
```

【4】 変更を保存する
・[変更を保存]をクリックして、変更を保存します。

![2-16 テストイベントを設定する](2-16-3.png){data-zoomable}
図 2-16 テストイベントを設定する

※自動的に保存されたイベントを編集に画面が切り替わります。

![2-16 テストイベントを設定する](2-16-4.png){data-zoomable}

### 2-6-2 テストイベントの実行

テストイベントを保存すると[保存されたイベント]のドロップダウンリストに登録されます。 ここで実行したいテストイベント(ここでは、いま登録した「MyTestEvent」)を選択して[テス ト]ボタンをクリックして実行します(図 2-17)。
テストイベントを削除するには、該当のイベントをドロップダウンリストから選択した状態で[削除]をクリックします。

![図 2-17 テストイベントの実行](2-16-4.png){data-zoomable}

図 2-17 テストイベントの実行

### 2-6-3 実行結果の確認

このようにして、登録した MyTestEvent を実行すると、図 2-18 のように実行結果が成功か失敗が表示されます。

![図 2-18 実行結果の成功の確認](2-18.png){data-zoomable}
図 2-18 実行結果の成功の確認

[詳細]をクリックすると実行結果が表示されます。この Lambda 関数では、「x」を「y」で割っ た答えを戻り値として返しています。先の例では、x に 10、y に 2 を指定したので、10 : 2 の結 果となる「{"result" : 5.03」が出力されていることがわかります(図 2-19)。
![図 2-19 詳細を表示したところ](2-19.png){data-zoomable}

図 2-19 詳細を表示したところ

またテストを実行すると、[コードソース]に[Execution results]というタブが付いて、ここ にも同じように、結果が表示されます。コピー&ペーストしたいときは、こちらから確認するほ うが、やりやすいでしょう(図 2-20)。
![図 2-20 詳細を表示したところ](2-20.png){data-zoomable}

図 2-20 [コードソース]に追加された[Execution results]タブ

---

コラム コードソースからテストする
一度登録したテストは、[コードソース]の[Test]メニューから実行できます。編集とテ ストを繰り返したいときは、こちらから操作するのが簡単です(図 2-21)。

![図 2-21 コードソースからテストする](2-21.png){data-zoomable}
図 2-21 コードソースからテストする

---

### 2-6-4 CloudWatch Logs を確認する

Lambda 関数を実行すると、CloudWatch Logs にも記録されます。図 2-18 において[ログ]と書かれているリンクをクリックすると、

![図 2-18 実行結果の成功の確認](2-18.png){data-zoomable}

該当の CloudWatch Logs が開かれます(図 2-22)。

![図 2-22 CloudWatch Logs で確認したところ](2-22.png){data-zoomable}
図 2-22 CloudWatch Logs で確認したところ

図 2-22 のログの行をクリックすると、[詳細]を表示できます。[詳細]には、CloudWatch の ログが表示されます(図 2-23)。

![図 2-23 ログの詳細出力](2-23.png){data-zoomable}
図 2-23 ログの詳細出力

ログには、次のように「x=xx」「y=xx」と表示されている箇所があります。

```python
x = 10
y = 2
```

これは、リスト 2-1 に示した Lambda 関数において、以下の print 関数の実行によって出力された部分です。

```
print("x = " + str(x))
print("y = " + str(y))
```

このように、Lambda 関数で print 関数などを用いて標準出力に出力した内容は、CloudWatch Logs に出力されます。デバッグなどで一時的に何かトレースしたいような場面では、こうした手 法を使うとよいでしょう。

:::tip CloudWatch コンソールからたどる
図 2-18 の画面で、[ログ]をクリックするのではなく、CloudWatch コンソールからたどる 場合は、図 2-24 の左側メニューの[ロググループ]を確認してください。

Lambda のログはグループ化されており、[ロググループ]をクリックすると、「/aws/lambda/ 関数名」というグループがあるはずです。ここをクリックすると、前掲の図 2-22 の画面が表示されます。

![2-24 CloudWatch Logs からログをたどる](2-24.png){data-zoomable}
図 2-24 CloudWatch Logs からログをたどる
:::

### 2-6-5 例外が発生したときの動作

ところで、Lambda 関数の実行時に何かしらのエラーや例外が発生したときは、関数はどのような動きをするのでしょうか? その動作を確認してみましょう。

■ 例外が発生する引数を設定して再テストする
リスト 2-1 では、「x÷y」の計算をしています。もし、「y が 0」なら、「0 で割るエラー」が発生するはずです。
そこでもう一度、[テストイベント]タブを開き、以下のように、y の値を「0」
に変更して、テストを再実行してみましょう(図 2-25)。

```python
"x" : 10,
"y" : 0
```

![2-25 yに 0 を設定して再テストする](2-25.png){data-zoomable}
図 2-25 y に 0 を設定して再テストする

![エラーになる](2-25-1.png){data-zoomable}

■ 例外が発生したときの挙動<br>
すると実行結果として、「"errorMessage": "division by zero"」というメッセージを含む JSON データが戻り、呼び出しに失敗することがわかります(図 2-26)。
![図 2-26 実行に失敗した場合](2-26.png){data-zoomable}
図 2-26 実行に失敗した場合

このように Python ランタイムで例外が発生した場合には errorMessage、errorType、requestId、 stackTrace の 4 つを含む JSON 文字列が返されます。なお、これらの情報は、CloudWatch Logs にも記載されます(図 2-27)。

![図 2-27 CloudWatch Logs 上で、実行の失敗を確認したところ](2-27.png){data-zoomable}
図 2-27 CloudWatch Logs 上で、実行の失敗を確認したところ

## 2-7 まとめ

本章では、Lambda 関数の基本を説明しました。Lambda 関数を実行するためには、アクセス権の設定といった特殊なところもありますが、結局のところ、次の書式を持つ関数に過ぎません。

```python
def ハンドラ (event, context):
    ...処理...
    return 戻り値
```

この章では、手作業で Lambda 関数を実行しましたが、AWS の各種サービスをトリガーとして実行される場合には、event の引数に、サービスやイベントごとにさまざまな情報が格納されて呼び出されます。

次章では、そうした「イベントから呼び出されるときの仕組み」について、見ていきます。

:::tip どのプログラミング言語で書くのがよいのか
本書では、プログラミング言語として Python3 系(Python 3.9)を使っています。どのプログラミング言語を使っても、Lambda の仕組み自体は、もちろん同じですが、その書き方は大きく異なります。

たとえば、JavaScript (Node.js)を使う場合、ハンドラは次のように 3 つの引数をとり、3 つ目の引数である「callback」は、戻り値を設定するのに使われます。

また Lambda 関数から S3 や DynamoDB などの AWS リソースにアクセスするときに使うライブラリも、まったく違います。

```python
exports.handler = (event, context, callback) => {
    //ここに処理を書く
    callback(null, "Hello");
};
```

単純な文法の違いではなく、関数の書式や戻り値の設定方法、そして利用するライブラリの違いもあるため、他のプログラミング言語で書かれたサンプルプログラムを、自分が使いたいプログラミング言語に翻訳して使うのは、少し困難です。

ですから Lambda プログラミングは、できるだけ実例の多いプログラミング言語を使うのが よいでしょう。

また、そのプログラミング言語やバージョンが、いつまでサポートされるのか(EOL:End Of Life)も重要です。

AWS は、それぞれのプログラミング言語に対応するランタイムを、いつまでサポートするのかを「ランタイムサポートポリシー」 \*7 として公開しています。

これは Lambda だけでなく、プログラミング言語自体のライフサイクルも関係します。たとえば Node.js は Python に比べて、短い間隔でアップデートされるため、頻繁な EOL 対応が必要になってきます。
:::

---

\*7 ランタイムサポートポリシー
[https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/lambda-runtimes.html](https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/lambda-runtimes.html)

\*8 Node.js リリース
[https://github.com/nodejs/Release#release-schedule](https://github.com/nodejs/Release#release-schedule)

---
